/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package homework03


import com.soywiz.korio.dynamic.KDynamic.Companion.map
import kotlinx.coroutines.*

//z3qwxa/additional_monads_not_defined_in_arrow

fun main(args: Array<String>) = runBlocking {

    val topicJobs = arrayListOf<Deferred<TopicSnapshot>>()
    val commentJobs = arrayListOf<Deferred<CommentsSnapshot>>()
    for (i in 0 until args.size step 2) {
        topicJobs.add(async { RedditClient.getTopic(args[i]) })
        commentJobs.add(async { RedditClient.getComments(args[i], args[i + 1]) })
    }

    val posts = topicJobs.awaitAll().map { it.posts }.flatten()
    val topicsCsv = csvSerialize(posts, Post::class)
    CsvWriter.write(topicsCsv, "subjects.csv")

    val comments = commentJobs.awaitAll().map { it.linearize() }.flatten()
    val commentsCsv = csvSerialize(comments, CommentsSnapshot::class)
    CsvWriter.write(commentsCsv, "comments.csv")
}